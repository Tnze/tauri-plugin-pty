{"version":3,"file":"index.es.js","sources":["../api/eventEmitter2.ts","../api/index.ts"],"sourcesContent":["/**\r\n * Copyright (c) 2019, Microsoft Corporation (MIT License).\r\n */\r\n\r\nimport { IDisposable } from \".\";\r\n\r\ninterface IListener<T> {\r\n  (e: T): void;\r\n}\r\n\r\nexport interface IEvent<T> {\r\n  (listener: (e: T) => any): IDisposable;\r\n}\r\n\r\nexport class EventEmitter2<T> {\r\n  private _listeners: IListener<T>[] = [];\r\n  private _event?: IEvent<T>;\r\n\r\n  public get event(): IEvent<T> {\r\n    if (!this._event) {\r\n      this._event = (listener: (e: T) => any) => {\r\n        this._listeners.push(listener);\r\n        const disposable = {\r\n          dispose: () => {\r\n            for (let i = 0; i < this._listeners.length; i++) {\r\n              if (this._listeners[i] === listener) {\r\n                this._listeners.splice(i, 1);\r\n                return;\r\n              }\r\n            }\r\n          }\r\n        };\r\n        return disposable;\r\n      };\r\n    }\r\n    return this._event;\r\n  }\r\n\r\n  public fire(data: T): void {\r\n    const queue: IListener<T>[] = [];\r\n    for (let i = 0; i < this._listeners.length; i++) {\r\n      queue.push(this._listeners[i]);\r\n    }\r\n    for (let i = 0; i < queue.length; i++) {\r\n      queue[i].call(undefined, data);\r\n    }\r\n  }\r\n}","/**\r\n * Copyright (c) 2017, Daniel Imms (MIT License).\r\n * Copyright (c) 2018, Microsoft Corporation (MIT License).\r\n * Copyright (c) 2023, Tnze (MIT License).\r\n */\r\nimport { invoke } from '@tauri-apps/api'\r\nimport { EventEmitter2 } from \"./eventEmitter2\";\r\n\r\n/**\r\n     * Forks a process as a pseudoterminal.\r\n     * @param file The file to launch.\r\n     * @param args The file's arguments as argv (string[]) or in a pre-escaped CommandLine format\r\n     * (string). Note that the CommandLine option is only available on Windows and is expected to be\r\n     * escaped properly.\r\n     * @param options The options of the terminal.\r\n     * @see CommandLineToArgvW https://msdn.microsoft.com/en-us/library/windows/desktop/bb776391(v=vs.85).aspx\r\n     * @see Parsing C++ Comamnd-Line Arguments https://msdn.microsoft.com/en-us/library/17w5ykft.aspx\r\n     * @see GetCommandLine https://msdn.microsoft.com/en-us/library/windows/desktop/ms683156.aspx\r\n     */\r\nexport function spawn(file: string, args: string[] | string, options: IPtyForkOptions | IWindowsPtyForkOptions): IPty {\r\n    return new TauriPty(file, args, options)\r\n}\r\n\r\nexport interface IBasePtyForkOptions {\r\n\r\n    /**\r\n     * Name of the terminal to be set in environment ($TERM variable).\r\n     */\r\n    name?: string;\r\n\r\n    /**\r\n     * Number of intial cols of the pty.\r\n     */\r\n    cols?: number;\r\n\r\n    /**\r\n     * Number of initial rows of the pty.\r\n     */\r\n    rows?: number;\r\n\r\n    /**\r\n     * Working directory to be set for the child program.\r\n     */\r\n    cwd?: string;\r\n\r\n    /**\r\n     * Environment to be set for the child program.\r\n     */\r\n    env?: { [key: string]: string | undefined };\r\n\r\n    /**\r\n     * String encoding of the underlying pty.\r\n     * If set, incoming data will be decoded to strings and outgoing strings to bytes applying this encoding.\r\n     * If unset, incoming data will be delivered as raw bytes (Buffer type).\r\n     * By default 'utf8' is assumed, to unset it explicitly set it to `null`.\r\n     */\r\n    encoding?: string | null;\r\n\r\n    /**\r\n     * (EXPERIMENTAL)\r\n     * Whether to enable flow control handling (false by default). If enabled a message of `flowControlPause`\r\n     * will pause the socket and thus blocking the child program execution due to buffer back pressure.\r\n     * A message of `flowControlResume` will resume the socket into flow mode.\r\n     * For performance reasons only a single message as a whole will match (no message part matching).\r\n     * If flow control is enabled the `flowControlPause` and `flowControlResume` messages are not forwarded to\r\n     * the underlying pseudoterminal.\r\n     */\r\n    handleFlowControl?: boolean;\r\n\r\n    /**\r\n     * (EXPERIMENTAL)\r\n     * The string that should pause the pty when `handleFlowControl` is true. Default is XOFF ('\\x13').\r\n     */\r\n    flowControlPause?: string;\r\n\r\n    /**\r\n     * (EXPERIMENTAL)\r\n     * The string that should resume the pty when `handleFlowControl` is true. Default is XON ('\\x11').\r\n     */\r\n    flowControlResume?: string;\r\n}\r\n\r\nexport interface IPtyForkOptions extends IBasePtyForkOptions {\r\n    /**\r\n     * Security warning: use this option with great caution,\r\n     * as opened file descriptors with higher privileges might leak to the child program.\r\n     */\r\n    uid?: number;\r\n    gid?: number;\r\n}\r\n\r\nexport interface IWindowsPtyForkOptions extends IBasePtyForkOptions {\r\n    /**\r\n     * Whether to use the ConPTY system on Windows. When this is not set, ConPTY will be used when\r\n     * the Windows build number is >= 18309 (instead of winpty). Note that ConPTY is available from\r\n     * build 17134 but is too unstable to enable by default.\r\n     *\r\n     * This setting does nothing on non-Windows.\r\n     */\r\n    useConpty?: boolean;\r\n\r\n    /**\r\n     * Whether to use PSEUDOCONSOLE_INHERIT_CURSOR in conpty.\r\n     * @see https://docs.microsoft.com/en-us/windows/console/createpseudoconsole\r\n     */\r\n    conptyInheritCursor?: boolean;\r\n}\r\n\r\n/**\r\n * An interface representing a pseudoterminal, on Windows this is emulated via the winpty library.\r\n */\r\nexport interface IPty {\r\n    /**\r\n     * The process ID of the outer process.\r\n     */\r\n    readonly pid: number;\r\n\r\n    /**\r\n     * The column size in characters.\r\n     */\r\n    readonly cols: number;\r\n\r\n    /**\r\n     * The row size in characters.\r\n     */\r\n    readonly rows: number;\r\n\r\n    /**\r\n     * The title of the active process.\r\n     */\r\n    readonly process: string;\r\n\r\n    /**\r\n     * (EXPERIMENTAL)\r\n     * Whether to handle flow control. Useful to disable/re-enable flow control during runtime.\r\n     * Use this for binary data that is likely to contain the `flowControlPause` string by accident.\r\n     */\r\n    handleFlowControl: boolean;\r\n\r\n    /**\r\n     * Adds an event listener for when a data event fires. This happens when data is returned from\r\n     * the pty.\r\n     * @returns an `IDisposable` to stop listening.\r\n     */\r\n    readonly onData: IEvent<string>;\r\n\r\n    /**\r\n     * Adds an event listener for when an exit event fires. This happens when the pty exits.\r\n     * @returns an `IDisposable` to stop listening.\r\n     */\r\n    readonly onExit: IEvent<{ exitCode: number, signal?: number }>;\r\n\r\n    /**\r\n     * Resizes the dimensions of the pty.\r\n     * @param columns The number of columns to use.\r\n     * @param rows The number of rows to use.\r\n     */\r\n    resize(columns: number, rows: number): void;\r\n\r\n    /**\r\n     * Clears the pty's internal representation of its buffer. This is a no-op\r\n     * unless on Windows/ConPTY. This is useful if the buffer is cleared on the\r\n     * frontend in order to synchronize state with the backend to avoid ConPTY\r\n     * possibly reprinting the screen.\r\n     */\r\n    clear(): void;\r\n\r\n    /**\r\n     * Writes data to the pty.\r\n     * @param data The data to write.\r\n     */\r\n    write(data: string): void;\r\n\r\n    /**\r\n     * Kills the pty.\r\n     * @param signal The signal to use, defaults to SIGHUP. This parameter is not supported on\r\n     * Windows.\r\n     * @throws Will throw when signal is used on Windows.\r\n     */\r\n    kill(signal?: string): void;\r\n\r\n    /**\r\n     * Pauses the pty for customizable flow control.\r\n     */\r\n    pause(): void;\r\n\r\n    /**\r\n     * Resumes the pty for customizable flow control.\r\n     */\r\n    resume(): void;\r\n}\r\n\r\n/**\r\n * An object that can be disposed via a dispose function.\r\n */\r\nexport interface IDisposable {\r\n    dispose(): void;\r\n}\r\n\r\n/**\r\n * An event that can be listened to.\r\n * @returns an `IDisposable` to stop listening.\r\n */\r\nexport interface IEvent<T> {\r\n    (listener: (e: T) => any): IDisposable;\r\n}\r\n\r\nexport type ArgvOrCommandLine = string[] | string;\r\n\r\nclass TauriPty implements IPty, IDisposable {\r\n    pid: number;\r\n    cols: number;\r\n    rows: number;\r\n    process: string;\r\n    handleFlowControl: boolean;\r\n\r\n    _exitted: boolean;\r\n\r\n    private _onData = new EventEmitter2<string>();\r\n    private _onExit = new EventEmitter2<{ exitCode: number; signal?: number | undefined; }>();\r\n\r\n    constructor(file: string, args?: ArgvOrCommandLine, opt?: IWindowsPtyForkOptions) {\r\n        args = typeof args === 'string' ? [args] : args ?? []; // Convert args to string[] anyways.\r\n        const invokeArgs = {\r\n            file, args,\r\n            termName: opt?.name ?? 'Terminal',\r\n            cols: opt?.cols ?? null,\r\n            rows: opt?.rows ?? null,\r\n            cwd: opt?.cwd ?? null,\r\n            env: opt?.env ?? {},\r\n            encoding: opt?.encoding ?? null,\r\n            handleFlowControl: opt?.handleFlowControl ?? null,\r\n            flowControlPause: opt?.flowControlPause ?? null,\r\n            flowControlResume: opt?.flowControlResume ?? null,\r\n        };\r\n        invoke<number>('plugin:pty|spawn', invokeArgs).then(pid => {\r\n            this._exitted = false;\r\n            this.pid = pid;\r\n            this.readData()\r\n        });\r\n    }\r\n    dispose(): void {\r\n        throw new Error(\"Method not implemented.\");\r\n    }\r\n\r\n    public get onData(): IEvent<string> { return this._onData.event; }\r\n    public get onExit(): IEvent<{ exitCode: number; signal?: number | undefined; }> { return this._onExit.event; }\r\n\r\n    resize(columns: number, rows: number): void {\r\n        this.cols = columns;\r\n        this.rows = rows;\r\n        invoke('plugin:pty|resize', { pid: this.pid, cols: columns, rows }).catch(e => {\r\n            console.error('Resize error: ', e);\r\n            this.errorCheck();\r\n        });\r\n    }\r\n    clear(): void {\r\n        throw new Error(\"Method not implemented.\");\r\n    }\r\n    write(data: string): void {\r\n        invoke('plugin:pty|write', { pid: this.pid, data }).catch(e => {\r\n            console.error('Writing error: ', e);\r\n            this.errorCheck();\r\n        });\r\n    }\r\n    kill(signal?: string | undefined): void {\r\n        throw new Error(\"Method not implemented.\");\r\n    }\r\n    pause(): void {\r\n        throw new Error(\"Method not implemented.\");\r\n    }\r\n    resume(): void {\r\n        throw new Error(\"Method not implemented.\");\r\n    }\r\n\r\n    private async readData() {\r\n        try {\r\n            for (; ;) {\r\n                const data = await invoke<string>('plugin:pty|read', { pid: this.pid });\r\n                this._onData.fire(data);\r\n            }\r\n        } catch (e: any) {\r\n            this.errorCheck();\r\n            if (typeof e === 'string' && e.includes('EOF')) {\r\n                return;\r\n            }\r\n            console.error('Reading error: ', e);\r\n        }\r\n    }\r\n\r\n    private async errorCheck() {\r\n        if (this._exitted) {\r\n            return;\r\n        }\r\n        try {\r\n            const exitCode = await invoke<number | null>('plugin:pty|exitstatus', { pid: this.pid })\r\n            if (exitCode != null) {\r\n                this._exitted = true;\r\n                this._onExit.fire({ exitCode });\r\n            }\r\n        } catch (e: any) {\r\n            console.error(e)\r\n        }\r\n    }\r\n}\r\n"],"names":[],"mappings":"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"}